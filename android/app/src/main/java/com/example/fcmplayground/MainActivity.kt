package com.example.fcmplayground

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Button
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.example.fcmplayground.ui.theme.FcmplaygroundTheme
import androidx.compose.runtime.getValue
import androidx.compose.runtime.setValue
import kotlinx.coroutines.*
import android.util.Log
import android.widget.Toast
import kotlinx.coroutines.*
import org.json.JSONObject
import java.net.HttpURLConnection
import java.net.URL




class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()

        // fixed debug user id
        val userId = "debug-user-1"

        // persistent device id from SharedPreferences
        val deviceId = DeviceIdManager.getOrCreateDeviceId(this)

        // API base URL from BuildConfig (generated by build.gradle.kts)
        val apiBaseUrl = BuildConfig.API_BASE_URL

        val initialFcmToken = FcmTokenStore.getToken(this)

        setContent {
            FcmplaygroundTheme {
                MainScreen(
                    userId = userId,
                    deviceId = deviceId,
                    apiBaseUrl = apiBaseUrl,
                    initialFcmToken = initialFcmToken,
                    onReRegisterClick = { latestFcmToken ->
                        registerDevice(
                            userId = userId,
                            deviceId = deviceId,
                            fcmToken = latestFcmToken,
                            apiBaseUrl = apiBaseUrl
                        )
                    }
                )
            }
        }
    }

    private fun registerDevice(
        userId: String,
        deviceId: String,
        fcmToken: String,
        apiBaseUrl: String
    ) {
        if (fcmToken.startsWith("FCM token not")) {
            Toast.makeText(
                /* context = */ this,
                /* text = */ "FCM token not ready yet",
                /* duration = */ Toast.LENGTH_SHORT
            ).show()
            return
        }

        val jsonBody = JSONObject().apply {
            put("user_id", userId)
            put("device_id", deviceId)
            put("fcm_token", fcmToken)
            put("platform", "android")
        }

        CoroutineScope(Dispatchers.IO).launch {
            try {
                val url = URL("$apiBaseUrl/devices/register")
                Log.d("API", "POST $url body=${jsonBody}")

                val conn = (url.openConnection() as HttpURLConnection).apply {
                    requestMethod = "POST"
                    connectTimeout = 10_000
                    readTimeout = 10_000
                    doOutput = true
                    setRequestProperty("Content-Type", "application/json")
                }

                conn.outputStream.use { os ->
                    os.write(jsonBody.toString().toByteArray(Charsets.UTF_8))
                }

                val code = conn.responseCode
                val responseText = try {
                    conn.inputStream.bufferedReader().use { it.readText() }
                } catch (_: Exception) {
                    ""
                }
                conn.disconnect()

                Log.d("API", "registerDevice HTTP $code, response=$responseText")

                withContext(Dispatchers.Main) {
                    Toast.makeText(
                        this@MainActivity,
                        "registerDevice: HTTP $code",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            } catch (e: Exception) {
                Log.e("API", "registerDevice failed", e)
                withContext(Dispatchers.Main) {
                    Toast.makeText(
                        this@MainActivity,
                        "register failed: ${e.message}",
                        Toast.LENGTH_SHORT
                    ).show()
                }
            }
        }
    }



}

@Composable
fun MainScreen(
    userId: String,
    deviceId: String,
    apiBaseUrl: String,
    initialFcmToken: String,
    onReRegisterClick: (String) -> Unit,   //
) {
    var fcmToken by remember { mutableStateOf(initialFcmToken) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        Text("user_id: $userId", style = MaterialTheme.typography.bodyLarge)
        Spacer(Modifier.height(8.dp))

        Text("device_id: $deviceId", style = MaterialTheme.typography.bodyLarge)
        Spacer(Modifier.height(8.dp))

        Text("FCM token: $fcmToken", style = MaterialTheme.typography.bodyLarge)
        Spacer(Modifier.height(8.dp))

        Text("API_BASE_URL: $apiBaseUrl", style = MaterialTheme.typography.bodyLarge)
        Spacer(Modifier.height(16.dp))

        Button(
            onClick = {
                // send fcmToken to Activity
                onReRegisterClick(fcmToken)
            }
        ) {
            Text("Re-register device")
        }
    }
}


@Preview(showBackground = true)
@Composable
fun MainScreenPreview() {
    FcmplaygroundTheme {
        MainScreen(
            userId = "debug-user-1",
            deviceId = "preview-device-id",
            apiBaseUrl = "https://example.com/dev",
            initialFcmToken = "preview-fcm-token",
            onReRegisterClick = {}   //place holder
        )
    }
}

